const fs = require('fs');
const path = require('path');
const moment = require('moment-timezone');
const cron = require('node-cron');
const crypto = require('crypto');
const fsExtra = require('fs-extra'); // ThÃªm fs-extra Ä‘á»ƒ Ä‘á»“ng bá»™

// --- Cáº¥u hÃ¬nh chung ---
const RENT_DATA_PATH = path.join(__dirname, 'cache/data/thuebot.json');
const TIMEZONE = 'Asia/Ho_Chi_Minh';

// Äáº£m báº£o thÆ° má»¥c cache/data tá»“n táº¡i
fsExtra.ensureDirSync(path.dirname(RENT_DATA_PATH));

let data = fs.existsSync(RENT_DATA_PATH) ? JSON.parse(fs.readFileSync(RENT_DATA_PATH, 'utf8')) : [];
const saveData = () => fs.writeFileSync(RENT_DATA_PATH, JSON.stringify(data, null, 2), 'utf8');

const isValidDate = dateString => {
    const d = moment(dateString, 'DD/MM/YYYY', true);
    return d.isValid();
};

async function streamURL(url, ext = 'jpg') {
    const tempFilePath = path.join(__dirname, 'cache', `${Date.now()}.${ext}`);
    const imageDownloader = require('image-downloader'); // Khai bÃ¡o cá»¥c bá»™

    try {
        await imageDownloader.image({ 'url': url, 'dest': tempFilePath });
        setTimeout(() => fsExtra.unlink(tempFilePath).catch(e => console.error("âš ï¸ Lá»—i xÃ³a file áº£nh táº¡m:", e)), 60 * 1000); // ThÃªm icon
        return fsExtra.createReadStream(tempFilePath);
    } catch (error) {
        console.error("âš ï¸ Lá»—i táº£i áº£nh tá»« URL:", error); // ThÃªm icon
        return null;
    }
};

// Cáº­p nháº­t hÃ m táº¡o key theo yÃªu cáº§u má»›i cá»§a mÃ y
const generateRandomKey = (length = 8) => {
    // Bao gá»“m chá»¯ thÆ°á»ng, chá»¯ in hoa vÃ  sá»‘
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; 
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
};

// Cáº¥u hÃ¬nh cá»§a lá»‡nh "rent"
module.exports.config = {
    name: "rent",
    version: "1.8.2", // TÄƒng version vÃ¬ cÃ³ cáº­p nháº­t logic táº¡o key
    hasPermssion: 2, // Chá»‰ Admin bot má»›i dÃ¹ng Ä‘Æ°á»£c, permssion 3 lÃ  bot owner
    credits: "LÆ°Æ¡ng TrÆ°á»ng KhÃ´i (mod by qh vÃ  Gemini) ğŸ‘‘", // ThÃªm credit cá»§a mÃ y vÃ  tao
    description: "ğŸ”‘ Quáº£n lÃ½ thuÃª bot, táº¡o key, xem thÃ´ng tin vÃ  danh sÃ¡ch. ", // MÃ´ táº£ ngáº¯n gá»n, cÃ³ icon
    commandCategory: "ADMIN",
    usePrefix: false,
    usages: "[newkey <sá»‘ ngÃ y> | add <TID> <UID> <DD/MM/YYYY> | info | list | checkkey <key> | removekey <TID/key> | extend <TID> <DD/MM/YYYY má»›i> | delete <TID/key>]", // Cáº­p nháº­t usages
    cooldowns: 3 // TÄƒng cooldown
};

// --- HÃ m chÃ­nh xá»­ lÃ½ lá»‡nh "rent" ---
module.exports.run = async function({ api, event, args, permssion }) {
    const { threadID, messageID, senderID } = event;
    const sendMessage = (msg, callback) => api.sendMessage(msg, threadID, callback, messageID);
    const botPrefix = global.config.PREFIX;

    // Kiá»ƒm tra quyá»n Admin
    if (!global.config.ADMINBOT.includes(senderID)) {
        return sendMessage('ğŸš« Báº¡n khÃ´ng pháº£i lÃ  Admin chÃ­nh Ä‘á»ƒ sá»­ dá»¥ng lá»‡nh nÃ y!');
    }

    const command = args[0]?.toLowerCase();
    const rentData = data;

    try { // ThÃªm try-catch Ä‘á»ƒ báº¯t lá»—i
        switch (command) {
            case "newkey": {
                if (!args[1]) {
                    return sendMessage(`âš ï¸ Sai cÃº phÃ¡p! Vui lÃ²ng nháº­p sá»‘ ngÃ y thuÃª.\nVÃ­ dá»¥: \`${botPrefix}${this.config.name} newkey 30\` (táº¡o key 30 ngÃ y).`);
                }

                const rentalDays = parseInt(args[1]);
                if (isNaN(rentalDays) || rentalDays <= 0) {
                    return sendMessage('â Sá»‘ ngÃ y thuÃª khÃ´ng há»£p lá»‡! Vui lÃ²ng nháº­p má»™t sá»‘ nguyÃªn dÆ°Æ¡ng.');
                }

                // Táº¡o key theo Ä‘á»‹nh dáº¡ng má»›i: qh-[8 kÃ½ tá»± ngáº«u nhiÃªn bao gá»“m sá»‘, chá»¯ thÆ°á»ng, chá»¯ in hoa]
                const generatedKey = `qh-${generateRandomKey()}`; 
                const timeEnd = moment().tz(TIMEZONE).add(rentalDays, 'days').format('DD/MM/YYYY');

                const message =
                    `âœ¨ **KEY THUÃŠ BOT Cá»¦A Báº N ÄÃ‚Y!** âœ¨\n` +
                    `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                    `ğŸ”‘ **Key:** \`${generatedKey}\`\n` +
                    `â³ **Háº¡n sá»­ dá»¥ng:** ${rentalDays} ngÃ y, háº¿t háº¡n vÃ o ${timeEnd}.\n` +
                    `ğŸ“Œ **HÆ°á»›ng dáº«n:** Äá»ƒ kÃ­ch hoáº¡t, hÃ£y chat **chÃ­nh xÃ¡c** key \`${generatedKey}\` vÃ o nhÃ³m nÃ y.\n` +
                    `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                    `ğŸ’¡ LÆ°u Ã½: Key nÃ y chá»‰ cÃ³ hiá»‡u lá»±c cho nhÃ³m nÃ y vÃ  cáº§n Ä‘Æ°á»£c kÃ­ch hoáº¡t trÆ°á»›c khi háº¿t háº¡n. `;

                api.sendMessage(message, threadID, (error, info) => {
                    if (!error) {
                        global.client.handleReply.push({
                            name: this.config.name,
                            messageID: info.messageID,
                            author: senderID,
                            type: 'newkey_confirm',
                            threadID: threadID,
                            generatedKey: generatedKey,
                            timeEnd: timeEnd
                        });
                    } else {
                        console.error("âš ï¸ Lá»—i khi gá»­i tin nháº¯n táº¡o key:", error);
                        sendMessage("âŒ ÄÃ£ xáº£y ra lá»—i khi táº¡o key. Vui lÃ²ng thá»­ láº¡i!");
                    }
                }, messageID);
                break;
            }

            case "add": {
                if (!args[1] || !args[2] || !args[3]) {
                    return sendMessage(`âš ï¸ CÃº phÃ¡p khÃ´ng Ä‘Ãºng!\nCÃ¡ch dÃ¹ng: \`${botPrefix}${this.config.name} add <TID nhÃ³m> <UID ngÆ°á»i thuÃª> <DD/MM/YYYY háº¿t háº¡n>\`\nVÃ­ dá»¥: \`${botPrefix}${this.config.name} add ${threadID} ${senderID} 31/12/2025\`. `);
                }
                const targetThreadID = args[1];
                const targetUserID = args[2];
                const timeEnd = args[3];

                if (isNaN(targetThreadID) || isNaN(targetUserID) || !isValidDate(timeEnd)) {
                    return sendMessage('â ID nhÃ³m, ID ngÆ°á»i thuÃª hoáº·c NgÃ y Háº¿t Háº¡n KhÃ´ng Há»£p Lá»‡! (Äá»‹nh dáº¡ng ngÃ y DD/MM/YYYY). ');
                }
                const timeStart = moment.tz(TIMEZONE).format('DD/MM/YYYY');
                const existingEntryIndex = rentData.findIndex(entry => entry.t_id === targetThreadID);

                let message = '';
                if (existingEntryIndex !== -1) {
                    Object.assign(rentData[existingEntryIndex], {
                        'id': targetUserID,
                        'time_start': timeStart,
                        'time_end': timeEnd
                    });
                    message = `âœ… ÄÃ£ gia háº¡n dá»¯ liá»‡u thuÃª bot cho nhÃ³m **${targetThreadID}** thÃ nh cÃ´ng! `;
                } else {
                    rentData.push({
                        't_id': targetThreadID,
                        'id': targetUserID,
                        'time_start': timeStart,
                        'time_end': timeEnd,
                        'key': null // Máº·c Ä‘á»‹nh khÃ´ng cÃ³ key náº¿u thÃªm thá»§ cÃ´ng
                    });
                    message = `âœ… ÄÃ£ thÃªm dá»¯ liá»‡u thuÃª bot cho nhÃ³m **${targetThreadID}** thÃ nh cÃ´ng! `;
                }
                sendMessage(message);
                break;
            }

            case "info": {
                const currentThreadData = rentData.find(entry => entry.t_id === threadID);
                if (!currentThreadData) {
                    return sendMessage('â NhÃ³m nÃ y chÆ°a cÃ³ dá»¯ liá»‡u thuÃª bot. Vui lÃ²ng liÃªn há»‡ Admin Ä‘á»ƒ thuÃª! ');
                }

                const timeEndMoment = moment(currentThreadData.time_end, 'DD/MM/YYYY');
                const nowMoment = moment().tz(TIMEZONE);

                if (timeEndMoment.isBefore(nowMoment, 'day')) {
                    // XÃ³a dá»¯ liá»‡u thuÃª náº¿u Ä‘Ã£ háº¿t háº¡n
                    data = data.filter(entry => entry.t_id !== threadID);
                    saveData();
                    return sendMessage('âš ï¸ Dá»¯ liá»‡u thuÃª bot cá»§a nhÃ³m báº¡n Ä‘Ã£ háº¿t háº¡n vÃ  Ä‘Ã£ Ä‘Æ°á»£c gá»¡ bá». Vui lÃ²ng liÃªn há»‡ Admin Ä‘á»ƒ gia háº¡n! ');
                }

                const duration = moment.duration(timeEndMoment.diff(nowMoment));
                const daysLeft = duration.days();
                const hoursLeft = duration.hours();
                const minutesLeft = duration.minutes();

                const userName = global.data.userName.get(currentThreadData.id) || (await api.getUserInfo(currentThreadData.id))[currentThreadData.id]?.name || `UID: ${currentThreadData.id}`;
                
                let userAvatar;
                try {
                    userAvatar = await streamURL(`https://graph.facebook.com/${currentThreadData.id}/picture?height=720&width=720&access_token=6628568379%7Cc1e620fa708a1d5696fb991c1bde5662`);
                } catch (e) {
                    console.error("âš ï¸ Lá»—i khi táº£i avatar ngÆ°á»i thuÃª:", e);
                    userAvatar = null;
                }

                sendMessage({
                    body: `âœ¨ **THÃ”NG TIN THUÃŠ BOT Cá»¦A NHÃ“M** âœ¨\n` +
                          `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                          `ğŸ‘¤ **NgÆ°á»i thuÃª:** ${userName}\n` +
                          `ğŸ—“ï¸ **NgÃ y thuÃª:** ${currentThreadData.time_start}\n` +
                          `â³ **Háº¿t háº¡n:** ${currentThreadData.time_end}\n` +
                          `ğŸ”‘ **Key hiá»‡n táº¡i:** ${currentThreadData.key || 'ChÆ°a cÃ³'}\n` +
                          `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                          `â° CÃ²n **${daysLeft} ngÃ y ${hoursLeft} giá» ${minutesLeft} phÃºt** ná»¯a lÃ  háº¿t háº¡n. `,
                    attachment: userAvatar ? [userAvatar] : []
                });
                break;
            }

            case "list": {
                if (rentData.length === 0) {
                    return sendMessage('â Hiá»‡n khÃ´ng cÃ³ nhÃ³m nÃ o Ä‘ang thuÃª bot! ');
                }
                let listMessageBody = `ğŸ“‹ **DANH SÃCH NHÃ“M ÄANG THUÃŠ BOT** ğŸ“‹\n\n`;

                for (let i = 0; i < rentData.length; i++) {
                    const entry = rentData[i];
                    const timeEndMoment = moment(entry.time_end, 'DD/MM/YYYY');
                    const nowMoment = moment().tz(TIMEZONE);
                    const isExpired = timeEndMoment.isBefore(nowMoment, 'day');

                    const duration = moment.duration(timeEndMoment.diff(nowMoment));
                    const daysLeft = duration.days();
                    const hoursLeft = duration.hours();
                    const status = isExpired ? 'ÄÃ£ Háº¿t Háº¡n âŒ' : 'CÃ²n Háº¡n âœ…';

                    const threadName = global.data.threadName.get(entry.t_id) || (await api.getThreadInfo(entry.t_id).then(t => t.threadName).catch(() => `TID: ${entry.t_id}`));
                    const userName = global.data.userName.get(entry.id) || (await api.getUserInfo(entry.id).then(u => u[entry.id]?.name).catch(() => `UID: ${entry.id}`));

                    listMessageBody += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                                       `ğŸ‘‰ **${i + 1}. NhÃ³m:** ${threadName}\n` +
                                       `ğŸ‘¤ **NgÆ°á»i thuÃª:** ${userName}\n` +
                                       `ğŸ—“ï¸ **NgÃ y thuÃª:** ${entry.time_start}\n` +
                                       `â³ **Háº¿t háº¡n:** ${entry.time_end}\n` +
                                       `ğŸ“ **TÃ¬nh tráº¡ng:** ${status}\n` +
                                       `â° **CÃ²n láº¡i:** ${isExpired ? 'ÄÃ£ háº¿t háº¡n' : `${daysLeft} ngÃ y ${hoursLeft} giá»`}\n` +
                                       `ğŸ”‘ **Key:** ${entry.key || 'ChÆ°a cÃ³'}\n` +
                                       `ğŸ”— **TID:** ${entry.t_id}\n`;
                }

                listMessageBody += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                                   `ğŸ‘‰ Reply **\`del <STT>\`** Ä‘á»ƒ xÃ³a nhÃ³m.\n` +
                                   `ğŸ‘‰ Reply **\`out <STT>\`** Ä‘á»ƒ bot out nhÃ³m.\n` +
                                   `ğŸ‘‰ Reply **\`giahan <STT> <DD/MM/YYYY má»›i>\`** Ä‘á»ƒ gia háº¡n thuÃª.\n` +
                                   `ğŸ‘‰ Reply **\`removekey <STT>\`** Ä‘á»ƒ xÃ³a key cá»§a nhÃ³m. `;

                sendMessage({ body: listMessageBody }, (error, info) => {
                    if (!error) {
                        global.client.handleReply.push({
                            ...info,
                            name: this.config.name,
                            type: 'list_manage',
                            data: rentData // Truyá»n toÃ n bá»™ data Ä‘á»ƒ handleReply cáº­p nháº­t trá»±c tiáº¿p
                        });
                    } else {
                        console.error("âš ï¸ Lá»—i khi gá»­i danh sÃ¡ch:", error);
                        sendMessage("âŒ ÄÃ£ xáº£y ra lá»—i khi táº¡o danh sÃ¡ch. ");
                    }
                });
                break;
            }

            case "key": {
                return sendMessage(`âš ï¸ Lá»‡nh **\`key\`** Ä‘Ã£ Ä‘Æ°á»£c thay tháº¿ báº±ng **\`newkey\`** vá»›i cÆ¡ cháº¿ má»›i.\nVui lÃ²ng sá»­ dá»¥ng: \`${botPrefix}${this.config.name} newkey <sá»‘ ngÃ y>\`. `);
            }

            case "checkkey": {
                if (!args[1]) {
                    return sendMessage(`âš ï¸ Vui lÃ²ng nháº­p key cáº§n kiá»ƒm tra.\nCÃ¡ch dÃ¹ng: \`${botPrefix}${this.config.name} checkkey <key_thuÃª>\`. `);
                }
                const inputKey = args[1].toLowerCase();

                const foundEntry = rentData.find(entry => entry.key?.toLowerCase() === inputKey);

                if (!foundEntry) {
                    return sendMessage(`â KhÃ´ng tÃ¬m tháº¥y nhÃ³m nÃ o vá»›i key: \`${inputKey}\`. `);
                }

                const timeEndMoment = moment(foundEntry.time_end, 'DD/MM/YYYY');
                const nowMoment = moment().tz(TIMEZONE);
                const isExpired = timeEndMoment.isBefore(nowMoment, 'day');

                const duration = moment.duration(timeEndMoment.diff(nowMoment));
                const daysLeft = duration.days();
                const hoursLeft = duration.hours();
                const minutesLeft = duration.minutes();
                const status = isExpired ? 'ÄÃ£ Háº¿t Háº¡n âŒ' : 'CÃ²n Háº¡n âœ…';

                const threadName = global.data.threadName.get(foundEntry.t_id) || (await api.getThreadInfo(foundEntry.t_id).then(t => t.threadName).catch(() => `TID: ${foundEntry.t_id}`));
                const userName = global.data.userName.get(foundEntry.id) || (await api.getUserInfo(foundEntry.id).then(u => u[foundEntry.id]?.name).catch(() => `UID: ${foundEntry.id}`));

                let userAvatar;
                try {
                    userAvatar = await streamURL(`https://graph.facebook.com/${foundEntry.id}/picture?height=720&width=720&access_token=6628568379%7Cc1e620fa708a1d5696fb991c1bde5662`);
                } catch (e) {
                    console.error("âš ï¸ Lá»—i khi táº£i avatar ngÆ°á»i thuÃª:", e);
                    userAvatar = null;
                }

                sendMessage({
                    body: `âœ¨ **THÃ”NG TIN NHÃ“M THEO KEY** âœ¨\n` +
                          `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                          `ğŸ‘‰ **NhÃ³m:** ${threadName}\n` +
                          `ğŸ‘¤ **NgÆ°á»i thuÃª:** ${userName}\n` +
                          `ğŸ—“ï¸ **NgÃ y thuÃª:** ${foundEntry.time_start}\n` +
                          `â³ **Háº¿t háº¡n:** ${foundEntry.time_end}\n` +
                          `ğŸ“ **TÃ¬nh tráº¡ng:** ${status}\n` +
                          `â° **CÃ²n láº¡i:** ${isExpired ? 'ÄÃ£ háº¿t háº¡n' : `${daysLeft} ngÃ y ${hoursLeft} giá» ${minutesLeft} phÃºt`}\n` +
                          `ğŸ”‘ **Key:** ${foundEntry.key}\n` +
                          `ğŸ”— **TID:** ${foundEntry.t_id}`,
                    attachment: userAvatar ? [userAvatar] : []
                });
                break;
            }

            case "removekey": {
                if (!args[1]) {
                    return sendMessage(`âš ï¸ Vui lÃ²ng nháº­p TID hoáº·c key cá»§a nhÃ³m cáº§n xÃ³a key.\nCÃ¡ch dÃ¹ng: \`${botPrefix}${this.config.name} removekey <TID_hoáº·c_key>\`. `);
                }
                const inputIdentifier = args[1].toLowerCase();

                const entryIndex = rentData.findIndex(entry => entry.t_id === inputIdentifier || entry.key?.toLowerCase() === inputIdentifier);

                if (entryIndex === -1) {
                    return sendMessage(`â KhÃ´ng tÃ¬m tháº¥y nhÃ³m nÃ o vá»›i TID/Key: \`${inputIdentifier}\`. `);
                }

                rentData[entryIndex].key = null;
                sendMessage(`âœ… ÄÃ£ xÃ³a key thuÃª bot cá»§a nhÃ³m **${rentData[entryIndex].t_id}** thÃ nh cÃ´ng! `);
                break;
            }

            case "delete": {
                if (!args[1]) {
                    return sendMessage(`âš ï¸ Vui lÃ²ng nháº­p TID hoáº·c key cá»§a nhÃ³m cáº§n xÃ³a dá»¯ liá»‡u.\nCÃ¡ch dÃ¹ng: \`${botPrefix}${this.config.name} delete <TID_hoáº·c_key>\`. `);
                }
                const inputIdentifier = args[1].toLowerCase();

                const entryIndex = rentData.findIndex(entry => entry.t_id === inputIdentifier || entry.key?.toLowerCase() === inputIdentifier);

                if (entryIndex === -1) {
                    return sendMessage(`â KhÃ´ng tÃ¬m tháº¥y nhÃ³m nÃ o vá»›i TID/Key: \`${inputIdentifier}\`. `);
                }

                const deletedEntry = rentData.splice(entryIndex, 1);
                sendMessage(`âœ… ÄÃ£ xÃ³a hoÃ n toÃ n dá»¯ liá»‡u thuÃª bot cá»§a nhÃ³m **${deletedEntry[0].t_id}** thÃ nh cÃ´ng! `);
                break;
            }

            case "extend": {
                if (!args[1] || isNaN(args[1]) || !args[2] || !isValidDate(args[2])) {
                    return sendMessage(`âš ï¸ CÃº phÃ¡p khÃ´ng Ä‘Ãºng!\nCÃ¡ch dÃ¹ng: \`${botPrefix}${this.config.name} extend <TID nhÃ³m> <DD/MM/YYYY háº¿t háº¡n má»›i>\`\nVÃ­ dá»¥: \`${botPrefix}${this.config.name} extend ${threadID} 31/12/2026\`. `);
                }
                const targetThreadID = args[1];
                const newTimeEnd = args[2];

                const entryIndex = rentData.findIndex(entry => entry.t_id === targetThreadID);

                if (entryIndex === -1) {
                    return sendMessage(`â NhÃ³m vá»›i TID **${targetThreadID}** chÆ°a cÃ³ dá»¯ liá»‡u thuÃª bot Ä‘á»ƒ gia háº¡n. Vui lÃ²ng dÃ¹ng lá»‡nh **\`${botPrefix}${this.config.name} add\`** hoáº·c **\`newkey\`** trÆ°á»›c. `);
                }

                rentData[entryIndex].time_end = newTimeEnd;
                // Thá»i gian báº¯t Ä‘áº§u sáº½ khÃ´ng thay Ä‘á»•i khi gia háº¡n, chá»‰ cáº­p nháº­t time_end
                // rentData[entryIndex].time_start = moment.tz(TIMEZONE).format('DD/MM/YYYY'); 

                sendMessage(`âœ… ÄÃ£ gia háº¡n thuÃª bot cho nhÃ³m **${targetThreadID}** Ä‘áº¿n **${newTimeEnd}** thÃ nh cÃ´ng! `);
                break;
            }

            default:
                sendMessage({
                    body: `âœ¨ **HÆ¯á»šNG DáºªN Lá»†NH RENT** âœ¨\n` +
                          `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                          `ğŸ‘‰ \`${botPrefix}rent newkey <sá»‘ ngÃ y>\`: Táº¡o key thuÃª bot theo sá»‘ ngÃ y (vÃ­ dá»¥: 30 ngÃ y).\n` +
                          `ğŸ‘‰ \`${botPrefix}rent add <TID> <UID ngÆ°á»i thuÃª> <DD/MM/YYYY>: ThÃªm/gia háº¡n nhÃ³m thá»§ cÃ´ng.\n` +
                          `ğŸ‘‰ \`${botPrefix}rent info\`: Xem thÃ´ng tin thuÃª bot cá»§a nhÃ³m hiá»‡n táº¡i.\n` +
                          `ğŸ‘‰ \`${botPrefix}rent list\`: Xem danh sÃ¡ch cÃ¡c nhÃ³m Ä‘ang thuÃª bot.\n` +
                          `ğŸ‘‰ \`${botPrefix}rent checkkey <key>\`: Kiá»ƒm tra thÃ´ng tin nhÃ³m báº±ng key.\n` +
                          `ğŸ‘‰ \`${botPrefix}rent removekey <TID_hoáº·c_key>\`: XÃ³a key cá»§a nhÃ³m.\n` +
                          `ğŸ‘‰ \`${botPrefix}rent extend <TID> <DD/MM/YYYY má»›i>\`: Gia háº¡n thá»i gian thuÃª bot.\n` +
                          `ğŸ‘‰ \`${botPrefix}rent delete <TID_hoáº·c_key>\`: XÃ³a hoÃ n toÃ n dá»¯ liá»‡u thuÃª bot cá»§a nhÃ³m.\n` +
                          `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                          `ğŸ’¡ **LÆ°u Ã½:** CÃ¡c lá»‡nh nÃ y chá»‰ Admin bot má»›i dÃ¹ng Ä‘Æ°á»£c! `
                });
                break;
        }
    } catch (e) {
        console.error("âš ï¸ Lá»—i trong lá»‡nh rent:", e);
        sendMessage("âŒ ÄÃ£ xáº£y ra sá»± cá»‘ khÃ´ng mong muá»‘n. Vui lÃ²ng thá»­ láº¡i sau! ");
    }
    saveData(); // LÆ°u dá»¯ liá»‡u sau má»—i thao tÃ¡c
};

// --- HÃ m xá»­ lÃ½ khi cÃ³ ngÆ°á»i dÃ¹ng reply hoáº·c chat key Ä‘á»ƒ xÃ¡c nháº­n ---
module.exports.handleEvent = async function({ api, event }) {
    const { threadID, messageID, senderID, body } = event;

    // Check if there's an active handleReply for newkey confirmation in this thread
    const activeReply = global.client.handleReply.find(
        reply => reply.name === this.config.name &&
                 reply.type === 'newkey_confirm' &&
                 reply.threadID === threadID &&
                 reply.author === senderID // Chá»‰ ngÆ°á»i táº¡o key (admin) má»›i cÃ³ thá»ƒ xÃ¡c nháº­n
    );

    if (activeReply) {
        const { generatedKey, timeEnd } = activeReply;

        // Náº¿u ngÆ°á»i dÃ¹ng chat Ä‘Ãºng key Ä‘Æ°á»£c táº¡o
        if (body?.toLowerCase() === generatedKey.toLowerCase()) {
            // XÃ³a handleReply Ä‘á»ƒ trÃ¡nh xá»­ lÃ½ trÃ¹ng láº·p
            global.client.handleReply = global.client.handleReply.filter(
                reply => !(reply.messageID === activeReply.messageID && reply.threadID === activeReply.threadID)
            );

            // Kiá»ƒm tra xem nhÃ³m Ä‘Ã£ cÃ³ dá»¯ liá»‡u thuÃª bot VÃ€ cÃ²n háº¡n khÃ´ng
            const existingEntry = data.find(entry => entry.t_id === threadID);
            if (existingEntry) {
                const existingTimeEndMoment = moment(existingEntry.time_end, 'DD/MM/YYYY');
                const nowMoment = moment().tz(TIMEZONE);
                if (existingTimeEndMoment.isAfter(nowMoment, 'day')) {
                    return api.sendMessage('ğŸš« NhÃ³m nÃ y Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t thuÃª bot vÃ  váº«n cÃ²n háº¡n. KhÃ´ng thá»ƒ kÃ­ch hoáº¡t key má»›i lÃºc nÃ y! ', threadID, messageID);
                } else {
                    // Náº¿u Ä‘Ã£ cÃ³ nhÆ°ng háº¿t háº¡n, sáº½ cáº­p nháº­t láº¡i
                    // XÃ³a má»¥c cÅ© náº¿u Ä‘Ã£ háº¿t háº¡n Ä‘á»ƒ thay tháº¿ báº±ng má»¥c má»›i
                    data = data.filter(entry => entry.t_id !== threadID);
                }
            }

            const timeStart = moment.tz(TIMEZONE).format('DD/MM/YYYY');
            data.push({
                't_id': threadID,
                'id': senderID,
                'time_start': timeStart,
                'time_end': timeEnd,
                'key': generatedKey
            });
            saveData();

            api.sendMessage(`âœ… ChÃºc má»«ng! NhÃ³m cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t thuÃª bot thÃ nh cÃ´ng vá»›i key: **${generatedKey}**!\nğŸ—“ï¸ Háº¡n dÃ¹ng Ä‘áº¿n ngÃ y **${timeEnd}**. `, threadID, messageID);

            // ThÃ´ng bÃ¡o tá»›i Admin
            const adminID = global.config.ADMINBOT[0]; // Giáº£ sá»­ láº¥y admin Ä‘áº§u tiÃªn
            if (adminID && adminID !== senderID) { // KhÃ´ng thÃ´ng bÃ¡o cho chÃ­nh admin vá»«a kÃ­ch hoáº¡t náº¿u lÃ  adminbot
                const threadInfo = await api.getThreadInfo(threadID);
                const senderInfo = await api.getUserInfo(senderID);
                api.sendMessage(
                    `ğŸ”” **ThÃ´ng bÃ¡o tá»« Bot:**\n\n` +
                    `â° **Thá»i gian:** ${moment().tz(TIMEZONE).format("DD/MM/YYYY HH:mm:ss")}\n` +
                    `ğŸ‘¤ **NgÆ°á»i kÃ­ch hoáº¡t:** ${senderInfo[senderID]?.name || `UID: ${senderID}`}\n` +
                    `ğŸ˜ï¸ **NhÃ³m:** ${threadInfo.threadName || `TID: ${threadID}`}\n` +
                    `ğŸ”‘ **Key:** ${generatedKey}\n` +
                    `ğŸ—“ï¸ **Háº¿t háº¡n:** ${timeEnd}`,
                    adminID
                );
            }
            return;
        } else if (body && body.toLowerCase().includes(generatedKey.toLowerCase().split('-')[1])) {
            // Tin nháº¯n nháº¹ nhÃ ng hÆ¡n, khÃ´ng bÃ¡o lá»—i cá»©ng
            api.sendMessage('âš ï¸ Key khÃ´ng chÃ­nh xÃ¡c. Vui lÃ²ng chat láº¡i **chÃ­nh xÃ¡c** key Ä‘Ã£ cáº¥p Ä‘á»ƒ kÃ­ch hoáº¡t!', threadID, messageID);
        }
    }

    // Call handleReply cho cÃ¡c action khÃ¡c (del, out, giahan, removekey)
    if (event.type === 'message_reply' && global.client.handleReply.length > 0) {
        const replyContext = global.client.handleReply.find(
            reply => reply.messageID === event.messageReply.messageID &&
                     reply.name === this.config.name &&
                     reply.type === 'list_manage'
        );
        if (replyContext) {
            // Äáº£m báº£o chá»‰ admin má»›i cÃ³ thá»ƒ reply cÃ¡c lá»‡nh quáº£n lÃ½
            if (!global.config.ADMINBOT.includes(senderID)) {
                return api.sendMessage('ğŸš« Báº¡n khÃ´ng Ä‘á»§ quyá»n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y!', threadID, messageID);
            }
            return module.exports.handleReply({ handleReply: replyContext, api, event });
        }
    }
};

// --- HÃ m xá»­ lÃ½ reply tá»« tin nháº¯n list_manage ---
module.exports.handleReply = async function({ handleReply: replyContext, api, event }) {
    const { threadID, messageID, senderID, body } = event;

    // Quyá»n Ä‘Ã£ Ä‘Æ°á»£c kiá»ƒm tra á»Ÿ handleEvent trÆ°á»›c Ä‘Ã³, nhÆ°ng cÃ³ thá»ƒ thÃªm láº¡i Ä‘á»ƒ Ä‘áº£m báº£o hÆ¡n
    if (!global.config.ADMINBOT.includes(senderID)) {
        return api.sendMessage('ğŸš« Báº¡n khÃ´ng Ä‘á»§ quyá»n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y!', threadID, messageID);
    }

    const sendMessageReply = (msg, callback) => api.sendMessage(msg, threadID, callback, messageID);
    const { type } = replyContext; // KhÃ´ng cáº§n currentRentData vÃ¬ sáº½ dÃ¹ng `data` global

    if (type !== 'list_manage') return;

    const messageBodyParts = body.toLowerCase().split(' ');
    const action = messageBodyParts[0];
    // const index = parseInt(action); // KhÃ´ng cáº§n dÃ²ng nÃ y ná»¯a vÃ¬ action cÃ³ thá»ƒ lÃ  chá»¯

    try {
        switch (action) {
            case 'del': {
                const deleteIndices = messageBodyParts.slice(1).map(Number).filter(n => !isNaN(n) && n >= 1 && n <= data.length); // DÃ¹ng data global
                if (deleteIndices.length === 0) return sendMessageReply('â Vui lÃ²ng nháº­p sá»‘ thá»© tá»± há»£p lá»‡ Ä‘á»ƒ xÃ³a. ');

                let deletedCount = 0;
                let notifiedThreads = [];
                // Sáº¯p xáº¿p giáº£m dáº§n Ä‘á»ƒ splice khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n index
                deleteIndices.sort((a, b) => b - a).forEach(stt => {
                    const entryToDelete = data[stt - 1];
                    if (entryToDelete) {
                        notifiedThreads.push(entryToDelete); // LÆ°u láº¡i Ä‘á»ƒ thÃ´ng bÃ¡o sau
                        data.splice(stt - 1, 1); // XÃ³a khá»i data global
                        deletedCount++;
                    }
                });
                saveData(); // LÆ°u láº¡i sau khi xÃ³a

                sendMessageReply(`âœ… ÄÃ£ xÃ³a thÃ nh cÃ´ng **${deletedCount}** má»¥c Ä‘Ã£ chá»n! `);
                // Gá»­i thÃ´ng bÃ¡o Ä‘áº¿n cÃ¡c nhÃ³m bá»‹ xÃ³a
                for (const entry of notifiedThreads) {
                    try {
                        await api.sendMessage(`ğŸš« **ThÃ´ng bÃ¡o tá»« Admin:**\n\nNhÃ³m cá»§a báº¡n Ä‘Ã£ bá»‹ gá»¡ khá»i danh sÃ¡ch thuÃª bot. Dá»¯ liá»‡u Ä‘Ã£ bá»‹ xÃ³a. Vui lÃ²ng liÃªn há»‡ Admin náº¿u cÃ³ tháº¯c máº¯c. `, entry.t_id);
                    } catch (e) {
                        console.error(`âš ï¸ Lá»—i khi thÃ´ng bÃ¡o nhÃ³m bá»‹ xÃ³a (${entry.t_id}):`, e);
                    }
                }
                break;
            }

            case 'out': {
                const outIndices = messageBodyParts.slice(1).map(Number).filter(n => !isNaN(n) && n >= 1 && n <= data.length); // DÃ¹ng data global
                if (outIndices.length === 0) return sendMessageReply('â Vui lÃ²ng nháº­p sá»‘ thá»© tá»± há»£p lá»‡ Ä‘á»ƒ bot out nhÃ³m. ');

                for (const stt of outIndices.sort((a, b) => a - b)) {
                    const targetEntry = data[stt - 1];
                    if (targetEntry) {
                        const targetThread = targetEntry.t_id;
                        try {
                            await api.removeUserFromGroup(api.getCurrentUserID(), targetThread);
                            sendMessageReply(`âœ… ÄÃ£ out khá»i nhÃ³m **${targetThread}** theo yÃªu cáº§u.`);
                            // XÃ³a dá»¯ liá»‡u thuÃª sau khi out
                            data = data.filter(entry => entry.t_id !== targetThread);
                        } catch (error) {
                            sendMessageReply(`âŒ Lá»—i khi out khá»i nhÃ³m **${targetThread}**: ${error.message}`);
                        }
                    }
                }
                saveData(); // LÆ°u láº¡i sau khi out
                break;
            }

            case 'giahan': {
                const sttToGiaHan = parseInt(messageBodyParts[1]);
                const newEndDate = messageBodyParts[2]; // ÄÃ¢y lÃ  DD/MM/YYYY

                if (isNaN(sttToGiaHan) || sttToGiaHan < 1 || sttToGiaHan > data.length || !isValidDate(newEndDate)) {
                    return sendMessageReply('â CÃº phÃ¡p gia háº¡n khÃ´ng Ä‘Ãºng hoáº·c ngÃ y khÃ´ng há»£p lá»‡!\nCÃ¡ch dÃ¹ng: `giahan <STT> <DD/MM/YYYY má»›i>`. ');
                }

                const entryToExtend = data[sttToGiaHan - 1]; // Truy cáº­p trá»±c tiáº¿p data global
                if (entryToExtend) {
                    entryToExtend.time_end = newEndDate;
                    // entryToExtend.time_start = moment.tz(TIMEZONE).format('DD/MM/YYYY'); // KhÃ´ng cáº§n cáº­p nháº­t ngÃ y báº¯t Ä‘áº§u khi gia háº¡n

                    sendMessageReply(`âœ… Gia háº¡n nhÃ³m **${entryToExtend.t_id}** thÃ nh cÃ´ng Ä‘áº¿n **${newEndDate}**! `);
                    try {
                        await api.sendMessage(`ğŸ”” **ThÃ´ng bÃ¡o tá»« Admin:**\n\nNhÃ³m cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gia háº¡n thuÃª bot Ä‘áº¿n ngÃ y **${newEndDate}**! `, entryToExtend.t_id);
                    } catch (e) {
                        console.error(`âš ï¸ Lá»—i khi thÃ´ng bÃ¡o gia háº¡n nhÃ³m (${entryToExtend.t_id}):`, e);
                    }
                } else {
                    sendMessageReply('â KhÃ´ng tÃ¬m tháº¥y má»¥c cáº§n gia háº¡n. ');
                }
                break;
            }

            case 'removekey': {
                const sttToRemoveKey = parseInt(messageBodyParts[1]);
                if (isNaN(sttToRemoveKey) || sttToRemoveKey < 1 || sttToRemoveKey > data.length) {
                    return sendMessageReply('â Vui lÃ²ng nháº­p sá»‘ thá»© tá»± há»£p lá»‡ Ä‘á»ƒ xÃ³a key. ');
                }
                const entryToUpdate = data[sttToRemoveKey - 1]; // Truy cáº­p trá»±c tiáº¿p data global
                if (entryToUpdate) {
                    const oldKey = entryToUpdate.key;
                    entryToUpdate.key = null;
                    sendMessageReply(`âœ… ÄÃ£ xÃ³a key **${oldKey || 'trÆ°á»›c Ä‘Ã³ khÃ´ng cÃ³'}** cá»§a nhÃ³m **${entryToUpdate.t_id}** thÃ nh cÃ´ng! `);
                } else {
                    sendMessageReply('â KhÃ´ng tÃ¬m tháº¥y má»¥c cáº§n xÃ³a key. ');
                }
                break;
            }

            default:
                // Náº¿u ngÆ°á»i dÃ¹ng reply báº±ng STT Ä‘á»ƒ xem chi tiáº¿t
                const index = parseInt(action);
                if (!isNaN(index) && index >= 1 && index <= data.length) {
                    const selectedEntry = data[index - 1]; // Truy cáº­p trá»±c tiáº¿p data global

                    const timeEndMoment = moment(selectedEntry.time_end, 'DD/MM/YYYY');
                    const nowMoment = moment().tz(TIMEZONE);
                    const isExpired = timeEndMoment.isBefore(nowMoment, 'day');

                    const duration = moment.duration(timeEndMoment.diff(nowMoment));
                    const daysLeft = duration.days();
                    const hoursLeft = duration.hours();
                    const minutesLeft = duration.minutes();
                    const status = isExpired ? 'ÄÃ£ Háº¿t Háº¡n âŒ' : 'CÃ²n Háº¡n âœ…';

                    const threadName = global.data.threadName.get(selectedEntry.t_id) || (await api.getThreadInfo(selectedEntry.t_id).then(t => t.threadName).catch(() => `TID: ${selectedEntry.t_id}`));
                    const userName = global.data.userName.get(selectedEntry.id) || (await api.getUserInfo(selectedEntry.id).then(u => u[selectedEntry.id]?.name).catch(() => `UID: ${selectedEntry.id}`));

                    let userAvatar;
                    try {
                        userAvatar = await streamURL(`https://graph.facebook.com/${selectedEntry.id}/picture?height=720&width=720&access_token=6628568379%7Cc1e620fa708a1d5696fb991c1bde5662`);
                    } catch (e) {
                        console.error("âš ï¸ Lá»—i khi táº£i avatar ngÆ°á»i thuÃª:", e);
                        userAvatar = null;
                    }

                    sendMessageReply({
                        body: `âœ¨ **THÃ”NG TIN CHI TIáº¾T THUÃŠ BOT** âœ¨\n` +
                              `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                              `ğŸ‘‰ **NhÃ³m:** ${threadName}\n` +
                              `ğŸ‘¤ **NgÆ°á»i thuÃª:** ${userName}\n` +
                              `ğŸ—“ï¸ **NgÃ y thuÃª:** ${selectedEntry.time_start}\n` +
                              `â³ **Háº¿t háº¡n:** ${selectedEntry.time_end}\n` +
                              `ğŸ“ **TÃ¬nh tráº¡ng:** ${status}\n` +
                              `â° **CÃ²n láº¡i:** ${isExpired ? 'ÄÃ£ háº¿t háº¡n' : `${daysLeft} ngÃ y ${hoursLeft} giá» ${minutesLeft} phÃºt`}\n` +
                              `ğŸ”‘ **Key:** ${selectedEntry.key || 'ChÆ°a cÃ³'}\n` +
                              `ğŸ”— **TID:** ${selectedEntry.t_id}`,
                        attachment: userAvatar ? [userAvatar] : []
                    });
                } else {
                    sendMessageReply('â Lá»‡nh khÃ´ng há»£p lá»‡! Vui lÃ²ng reply "del <STT>", "out <STT>", "giahan <STT> <DD/MM/YYYY má»›i>", "removekey <STT>" hoáº·c sá»‘ STT Ä‘á»ƒ xem chi tiáº¿t.');
                }
                break;
        }
    } catch (e) {
        console.error("âš ï¸ Lá»—i trong handleReply lá»‡nh rent:", e);
        sendMessageReply("âŒ ÄÃ£ xáº£y ra sá»± cá»‘ khÃ´ng mong muá»‘n khi xá»­ lÃ½ pháº£n há»“i. Vui lÃ²ng thá»­ láº¡i sau! ");
    }
    saveData(); // LÆ°u dá»¯ liá»‡u sau má»—i thao tÃ¡c trong handleReply
};

// --- Cron job tá»± Ä‘á»™ng kiá»ƒm tra háº¿t háº¡n (KHÃ”NG Äá»”I BIá»†T DANH) ---
// Cháº¡y vÃ o 00:00 hÃ ng ngÃ y
cron.schedule('0 0 * * *', async () => {
    console.log('ğŸ”„ Äang kiá»ƒm tra tráº¡ng thÃ¡i thuÃª bot vÃ  thÃ´ng bÃ¡o háº¿t háº¡n...');
    if (global.api) {
        for (const entry of data) {
            const threadID = entry.t_id;
            const timeEndMoment = moment(entry.time_end, 'DD/MM/YYYY');
            const nowMoment = moment().tz(TIMEZONE);
            const isExpired = timeEndMoment.isBefore(nowMoment, 'day');

            if (isExpired && entry.notifiedExpired !== true) { // Náº¿u Ä‘Ã£ háº¿t háº¡n vÃ  chÆ°a thÃ´ng bÃ¡o
                try {
                    // Gá»­i thÃ´ng bÃ¡o háº¿t háº¡n tá»›i nhÃ³m
                    await global.api.sendMessage(`âš ï¸ **BOT Háº¾T Háº N!** âš ï¸\n\nBot Ä‘Ã£ háº¿t háº¡n thuÃª trong nhÃ³m báº¡n tá»« ngÃ y **${entry.time_end}**. Vui lÃ²ng liÃªn há»‡ Admin (**${global.config.ADMINBOT[0]}**) Ä‘á»ƒ gia háº¡n dá»‹ch vá»¥!`, threadID);
                    entry.notifiedExpired = true; // ÄÃ¡nh dáº¥u Ä‘Ã£ thÃ´ng bÃ¡o
                    console.log(`âœ… ÄÃ£ gá»­i thÃ´ng bÃ¡o háº¿t háº¡n cho nhÃ³m ${threadID}.`);
                } catch (error) {
                    console.error(`âŒ Lá»—i khi gá»­i thÃ´ng bÃ¡o háº¿t háº¡n cho nhÃ³m ${threadID}:`, error);
                }
            } else if (!isExpired && entry.notifiedExpired === true) {
                // Náº¿u nhÃ³m Ä‘Æ°á»£c gia háº¡n láº¡i, reset tráº¡ng thÃ¡i thÃ´ng bÃ¡o
                entry.notifiedExpired = false;
            }
        }
        saveData(); // LÆ°u láº¡i dá»¯ liá»‡u sau khi kiá»ƒm tra vÃ  cáº­p nháº­t tráº¡ng thÃ¡i
    } else {
        console.error("âŒ Lá»—i: global.api chÆ°a Ä‘Æ°á»£c gÃ¡n, khÃ´ng thá»ƒ cháº¡y cron job checkExpiredGroups.");
    }
});